---
title: 'Clean and validate case data'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to clean and standardize case data?
- How to convert raw dataset into a `linelist` object?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Explain how clean, curate, and standardize case data using `{cleanepi}` package
- Demonstrate how to covert case data to `linelist` data 

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction
In the process of analyzing outbreak data, it's essential to ensure that the dataset is clean, curated, standardized, and validate to facilitate accurate and reproducible analysis. This episode focuses on cleaning epidemics and outbreaks data using the [cleanepi](https://epiverse-trace.github.io/cleanepi/) package, and validate it using the [linelist](https://epiverse-trace.github.io/linelist/) package. For demonstration purposes, we'll work with a simulated dataset of Ebola cases.


The first step is to import the dataset following the guidelines outlined in the [Read case data](../episodes/read-cases.Rmd) episode. This involves loading the dataset into our environment and view its structure and content. 

```{r}
requireNamespace("rio", quietly = TRUE)
raw_ebola_data <- rio::import(
  file.path("data", "simulated_ebola_2.csv", fsep = "/")
)
utils::head(raw_ebola_data, 5)
```

##  Quick inspection

Quick exploration and inspection of the dataset are crucial before diving into any analysis tasks. The `{cleanepi}` package simplifies this process with the `scan_data()` function. Let's take a look at how you can use it:

```{r}
requireNamespace("cleanepi", quietly = TRUE)
cleanepi::scan_data(raw_ebola_data)
```


The results provides an overview of the content of every column, including column names, and the percent of some data types per column.
You can see that the column names in the dataset are descriptive but lack consistency, as some they are composed of multiple words separated by white spaces. Additionally, some columns contain more than one data type, and there are missing values in others.

## Common data cleaning operations

This section  demonstrate how to perform some common data cleaning operations using the `{cleanepi}` package.

### Standardizing column names

For this example dataset, standardizing column names typically involves removing spaces and connecting different words with “_”. This practice helps maintain consistency and readability in the dataset.
However, the function used for standardizing column names offers more options. Type `?cleanepi::standardize_column_names` for more details.

```{r}
sim_ebola_data <- cleanepi::standardize_column_names(raw_ebola_data)
names(sim_ebola_data)
```

::::::::::::::::::::::::::::::::::::: challenge 

- What differences you can observe in the column names?

::::::::::::::::::::::::::::::::::::::::::::::::

If you want to maintain certain column names without subjecting them to the standardization process, you can utilize the `keep` parameter of the `standardize_column_names()` function. This parameter accepts a vector of column names that are intended to be kept unchanged.

**Exercise:** Standardize the column names of the input dataset, but keep the “V1” column as is.

### Removing irregularities

Raw data may contain irregularities such as duplicated and empty rows and columns, as well as constant columns. `remove_duplicates` and `remove_constants` functions from `{cleanepi}`  remove such irregularities as demonstrated in the below code chunk. 

```{r}
sim_ebola_data <- cleanepi::remove_constant(sim_ebola_data)
sim_ebola_data <- cleanepi::remove_duplicates(sim_ebola_data)
```

Note that, our simulated Ebola does not contain duplicated nor constant rows or columns. 

### Replacing missing values

In addition to the regularities, raw data can contain missing values that may be encoded by different strings, including the empty. To ensure robust analysis, it is a good practice to replace all missing values by `NA` in the entire dataset. Below is a code snippet demonstrating how you can achieve this in `{cleanepi}`:

```{r}
sim_ebola_data <- cleanepi::replace_missing_values(sim_ebola_data)
```

### Validating subject IDs

Each entry in the dataset represents a subject and should be distinguishable by a specific column formatted in a particular way, such as falling within a specified range, containing certain prefixes and/or suffixes, containing a specific number of characters. The `{cleanepi}` package offers the `check_subject_ids` function designed precisely for this task as shown in the below code chunk. This function validates whether they are unique and meet the required criteria.

```{r}
# remove this chunk code once `{cleanepi}` is updated. The coercion made here
# cwill be accounted for within `{cleanepi}`
sim_ebola_data$case_id <- as.character(sim_ebola_data$case_id)
```

```{r}
sim_ebola_data <- cleanepi::check_subject_ids(sim_ebola_data,
  target_columns = "case_id",
  range = c(0, 15000)
)
```

Note that our simulated  dataset does contain duplicated subject IDS.

### Standardizing dates

Certainly an epidemic dataset contains date columns for different events, such as the date of infection, date of symptoms onset, ..etc, and these dates can come in different date forms, and it good practice to unify them. The `{cleanepi}` package provides functionality for converting date columns in epidemic datasets into ISO format, ensuring consistency across the different date columns. Here's how you can use it on our simulated dataset:

```{r}
sim_ebola_data <- cleanepi::standardize_dates(
  sim_ebola_data,
  target_columns = c(
    "date_onset",
    "date_sample"
  )
)

utils::head(sim_ebola_data)
```

This function coverts the values in the target columns, or will automatically figure out the date columns within the dataset (if `target_columns = NULL`) and convert them into the **Ymd**  format.

### Converting to numeric values

In the raw dataset, some column can come with mixture of character and numerical values, and you want to covert the character values explicitly into numeric. For example, in our simulated data set, in the age column some entries are written in words. 
The `convert_to_numeric()` function in `{cleanepi}` does such conversion as illustrated in the below code chunk.
```{r}
sim_ebola_data <- cleanepi::convert_to_numeric(sim_ebola_data,
  target_columns = "age"
)
utils::head(sim_ebola_data)
```

## Epidemiology related data cleaning operations

In addition to common data cleansing tasks, such as those discussed in the above section, the `{cleanepi}` package offers 
additional functionalities tailored specifically for processing and analyzing outbreak and epidemic data. This section 
covers some of these specialized tasks.

### Checking sequence of dated-events

Ensuring the correct order and sequence of dated events is crucial in epidemiological data analysis, especially 
when analyzing infectious diseases where the timing of events like symptom onset and sample collection is essential. 
The `{cleanepi}` package provides a helpful function called `check_date_sequence()` precisely for this purpose.
Here's an example code chunk demonstrating the usage of `check_date_sequence()` function in our simulated Ebola dataset
 ```{r}
sim_ebola_data <- cleanepi::check_date_sequence(
  data = sim_ebola_data,
  target_columns = c("date_onset", "date_sample"),
  remove = TRUE
)
 ```

This functionality is crucial for ensuring data integrity and accuracy in epidemiological analyses, as it helps identify 
any inconsistencies or errors in the chronological order of events, allowing yor to address them appropriately.

### Dictionary-based substitution

In the realm of data preprocessing, it's common to encounter scenarios where certain columns in a dataset, such as the "gender" column in our simulated Ebola dataset,
are expected to have specific values or factors. However, it's also common for unexpected or erroneous values to appear in these
columns, which need to be replaced with appropriate values. The `{cleanepi}` package offers support for dictionary-based 
substitution, a method that allows you to replace values in specific columns based on mappings defined in a dictionary. 
This approach ensures consistency and accuracy in data cleaning.

Moreover, `{cleanepi}` provides a built-in dictionary specifically tailored for epidemiological data.
 This dictionary includes mappings for the "gender" column. 
```{r}
test_dict <- base::readRDS(system.file("extdata",
  "test_dict.RDS",
  package = "cleanepi"
))
base::print(test_dict)
```

Now, we can use this dictionary to standardize values of the the `gender` column according to predefined categories. Below is an example code chunk demonstrating how to utilize this functionality:
```{r}
sim_ebola_data <- cleanepi::clean_using_dictionary(sim_ebola_data,
  dictionary = test_dict
)
utils::head(sim_ebola_data)
```
This approach simplifies the data cleaning process, ensuring that categorical data in epidemiological datasets is 
accurately categorized and ready for further analysis.

### Calculating time span between different date events

In epidemiological data analysis it is also useful to  track and analyze time-dependent events, such as the progression of a disease outbreak or the duration between sample collection and analysis.
The `{cleanepi}` package  offers a convenient function for calculating the time elapsed between two dated events at different 
time scales. For example,  the below code snippet  utilizes the `span()` function to compute the time elapsed since the date of sample for the case identified
 until the  date this document was generated  (`r Sys.Date()`).
```{r}
sim_ebola_data <- cleanepi::span(sim_ebola_data,
  target_column = "date_sample",
  end_date = Sys.Date(),
  span_unit = "years",
  span_column_name = "time_since_sampling_date",
  span_remainder_unit = "months"
)
utils::head(sim_ebola_data)
```
After executing the `span()` function, two new columns named `time_since_sampling_date` and `remainder_months` are 
added to the sim_ebola_data dataset, containing the calculated time elapsed since the date of sampling for each case, 
measured in years, and the remaining time less that is year, measured in months.

## Multiple operations at once

Performing data cleaning operations individually can be time-consuming and error-prone. The `{cleanepi}` package 
simplifies this process by offering a convenient wrapper function called clean_data, which allows you to perform 
multiple  operations at once.

The clean_data function applies a series of predefined data cleaning operations to the input dataset. Here's an example 
code chunk illustrating how to use clean_data on a raw simulated Ebola dataset:

```{r}
ops <- list(
  standardize_column_names = list(keep = NULL, rename = NULL),
  replace_missing_values = list(
    target_columns = NULL,
    na_strings = cleanepi::common_na_strings
  ),
  remove_duplicates = list(
    target_columns = NULL,
    rm_empty_rows = TRUE,
    rm_empty_cols = TRUE,
    rm_constant_cols = TRUE
  ),
  standardize_dates = list(
    target_columns = c("date_onset", "date_sample"),
    error_tolerance = 0.5,
    format = NULL,
    timeframe = NULL,
    orders = list(
      world_named_months = c("Ybd", "dby"),
      world_digit_months = c("dmy", "Ymd"),
      US_formats = c("Omdy", "YOmd")
    )
  ),
  standardize_subject_ids = list(
    target_columns = "case_id"
  ),
  dictionary = test_dict,
  to_numeric = "age"
)
clean_data <- cleanepi::clean_data(
  data = raw_ebola_data,
  params = ops
)
```

### Printing the clean report
[TBC]

## Validating case data
