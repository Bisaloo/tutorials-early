---
title: 'Aggregate and visulaize'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to aggregate case data? 
- How to visualize aggregated data?
- What is distribution of cases in time, place, gender, age?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Convert case data to incidence 
- Create epidemic curves from incidence data
- Estimate the growth rate from incidence curves
- Create quick descriptive and comparison tables

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction
In an analytic pipeline, exploratory data analysis (EDA) is an important step before formal modelling. EDA helps 
determine relationships between variables and summarize their main characteristics often by means of data visualization. 

This episode focuses on  EDA of outbreaks and epidemic data, and how to achieved that using a couples of handy `R` 
packages. A key observation in DA in epidemic analysis is discerning the relationship between time and the number of 
reported cases, spanning various categories (confirmed, hospitalized, deaths, and recoveries), locations, and other 
demographic factors such as gender, age, etc.  
 
## Synthetic outbreak 
To demonstrate how to perform EDA on an outbreak data, we are going to generate line list of a hypthoical Ebola outbreak
using the `{simulist}` package. The line list dataset provide an individual-level information about the outbreak. 

```{r}
requireNamespace("simulist", quietly = TRUE)
requireNamespace("epiparameter", quietly = TRUE)
contact_dist <- epiparameter::epidist(
  disease = "Ebola",
  epi_dist = "contact distribution",
  prob_distribution = "pois",
  prob_distribution_params = c(mean = 4)
)
cont_interval <- epiparameter::epidist(
  disease = "COVID-19",
  epi_dist = "contact interval",
  prob_distribution = "gamma",
  prob_distribution_params = c(shape = 1, scale = 1)
)
# get onset to death from {epiparameter} database
onset_to_death <- epiparameter::epidist_db(
  disease = "Ebola",
  epi_dist = "onset to death",
  single_epidist = TRUE
)
linelist <- simulist::sim_linelist(
  contact_distribution = contact_dist,
  contact_interval = cont_interval,
  prob_infect = 0.8,
  onset_to_death = onset_to_death
)
```

## Old code
```{r, warning=FALSE, message=FALSE}
requireNamespace("outbreaks", quietly = TRUE)
covid19_eng_case_data <- outbreaks::covid19_england_nhscalls_2020
utils::head(covid19_eng_case_data, 5)
```

## Incidence data

Downstream analysis involves working with aggregated data rather than individual cases. This requires aggregating case data in the form of incidence data. The [incidence2]((https://www.reconverse.org/incidence2/articles/incidence2.html){.external target="_blank"}) package offers an essential function, called `incidence`, for grouping case data, usually centered around dated events and/or other factors. The code chunk provided below demonstrates the creation of an `incidence2` object from the `covid19_eng_case_data` based on the sampling date.

```{r, message=FALSE, warning=FALSE}
requireNamespace("incidence2", quietly = TRUE)
covid19_eng_incidence_data <- incidence2::incidence(
  covid19_eng_case_data,
  date_index = "date"
)
utils::head(covid19_eng_incidence_data, 5)
```

The `incidence2` object can be visualized using the `plot()` function from base R package. 

```{r, message=FALSE, warning=FALSE}
base::plot(covid19_eng_incidence_data)
```

Moreover, `{incidence2}` has other functions that allow for aggregating case data based on a dated event and other factors such as the individual gender, the sampling location, etc. In the example below, we calculate weekly counts of Covid-19 cases in England grouping them by `sex` type.

```{r, message=FALSE, warning=FALSE}
weekly_covid19_eng_incidence <- incidence2::incidence(
  covid19_eng_case_data,
  date_index = "date",
  interval = "week",
  groups = "sex"
)
base::plot(weekly_covid19_eng_incidence, angle = 45)
```



::::::::::::::::::::::::::::::::::::: challenge 

## Challenge 1: Can you do it?

 - Using the above `covid91_eng_case_data`  dataset, produce monthly epi-curves for Covid-19 cases in England based on regional places in England?

:::::::::::::::::::::::: solution 

 
```{r}
monthly_covid19_eng_incidence <- incidence2::incidence(
  covid19_eng_case_data,
  date_index = "date",
  interval = "month",
  groups = "sex"
)
base::plot(monthly_covid19_eng_incidence, angle = 45)
```

:::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::: keypoints 

- Use `{incidence2}` to aggregate case data based on a date event.  
::::::::::::::::::::::::::::::::::::::::::::::::

